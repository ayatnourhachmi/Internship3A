{
    "html_content": "<!DOCTYPE html>\n<html lang=\"en\">\n <head>\n  <meta charset=\"utf-8\"/>\n  <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\"/>\n  <title>\n   How to Connect to a Proxy Before Tor in Whonix\n  </title>\n  <link href=\"../general.css\" rel=\"stylesheet\" type=\"text/css\"/>\n </head>\n <body>\n  <div id=\"header\">\n   <div class=\"content\">\n    <h2>\n     <a href=\"/\">\n      Oil and Fish\n     </a>\n    </h2>\n   </div>\n  </div>\n  <div id=\"main\">\n   <div class=\"content\">\n    <h1>\n     How to Connect to a Proxy Before Tor in Whonix\n    </h1>\n    <p>\n     Connecting to a proxy before Tor helps to evade censorship. It also mitigates the risk of being dependent on Tor alone.\n    </p>\n    <p>\n     This article provides practical instructions to complement the material on this subject in the\n     <a href=\"https://www.whonix.org/wiki/Tunnels/Connecting_to_a_proxy_before_Tor\" target=\"_blank\">\n      Whonix wiki\n     </a>\n     .\n    </p>\n    <p>\n     To follow along with this tutorial, you need a server you can connect to. This server may be set up by yourself or by a trusted friend. You could alternatively use a free public-interest server. This would have the additional advantage that your traffic would be mixed in with many other people’s.\n    </p>\n    <p>\n     We do not describe in this article how to set up the server. We cover only the client part of the set-up. If you are interested in setting up a server, please see the other articles on this site.\n    </p>\n    <p>\n     The general idea is to specify your server in the Whonix Gateway VM as a proxy server, so that your encrypted traffic will pass through your tunnel before it gets to the Tor network.\n    </p>\n    <h2>\n     <a id=\"1\">\n     </a>\n     1. Shadowsocks\n    </h2>\n    <h3>\n     <a id=\"1-1\">\n     </a>\n     1.1. Install Shadowsocks-Libev Client on Gateway\n    </h3>\n    <p>\n     Shadowsocks is the original network tunneling technique designed by clowwindy.\n    </p>\n    <p>\n     We are going to install the C version of the Shadowsocks client on the Gateway virtual machine. Start the Gateway VM if it is not already running. Open a terminal on the Whonix Gateway, and issue the commands:\n    </p>\n    <blockquote>\n     <code>\n      sudo apt update\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo apt install shadowsocks-libev -y\n     </code>\n    </blockquote>\n    <p>\n     The installation places a default configuration file in\n     <code>\n      /etc/shadowsocks-libev/config.json\n     </code>\n     .\n    </p>\n    <p>\n     After the install has finished, the\n     <code>\n      shadowsocks-libev\n     </code>\n     service is active and running with the default configuration file.\n    </p>\n    <h3>\n     <a id=\"1-2\">\n     </a>\n     1.2. Obtain Shadowsocks Server Details\n    </h3>\n    <p>\n     Shadowsocks server configurations are usually distributed as Shadowsocks (“SS”) URLs. These are base-64 encoded strings that begin with the characters\n     <code>\n      ss://\n     </code>\n     . Here is an example of what an SS URL looks like:\n    </p>\n    <blockquote>\n     <code>\n      ss://Y2hhY2hhMjAtaWV0Zi1wb2x5MTMwNTpCcjhGd2ZMYmpSYWVxajU1QCoqLioqKi4qKiouKioqOjI5OTc0\n     </code>\n    </blockquote>\n    <p>\n     The base-64 part of this can be decoded by the\n     <code>\n      base64 --decode\n     </code>\n     command:\n    </p>\n    <blockquote>\n     <code>\n      echo 'Y2hhY2hhMjAtaWV0Zi1wb2x5MTMwNTpCcjhGd2ZMYmpSYWVxajU1QCoqLioqKi4qKiouKioqOjI5OTc0' | base64 --decode &amp;&amp; echo ''\n     </code>\n    </blockquote>\n    <p>\n     This command yields a result like this:\n    </p>\n    <blockquote>\n     <code>\n      chacha20-ietf-poly1305:Br8FwfLbjRaeqj55@**.***.***.***:29974\n     </code>\n    </blockquote>\n    <p>\n     You must pick the parameters out of the result. Continuing this example, this gives you these configuration parameters:\n    </p>\n    <ul>\n     <li>\n      Server IP address\n      <code>\n       **.***.***.***\n      </code>\n     </li>\n     <li>\n      Server port\n      <code>\n       29974\n      </code>\n     </li>\n     <li>\n      Encryption method\n      <code>\n       chacha20-ietf-poly1305\n      </code>\n     </li>\n     <li>\n      Password\n      <code>\n       Br8FwfLbjRaeqj55\n      </code>\n     </li>\n    </ul>\n    <h3>\n     <a id=\"1-3\">\n     </a>\n     1.3. Configure Shadowsocks-Libev Client on Gateway\n    </h3>\n    <p>\n     Install the\n     <code>\n      vi\n     </code>\n     editor:\n    </p>\n    <blockquote>\n     <code>\n      sudo apt install vim -y\n     </code>\n    </blockquote>\n    <p>\n     Edit the default configuration file,\n     <code>\n      /etc/shadowsocks-libev/config.json\n     </code>\n     .\n    </p>\n    <blockquote>\n     <code>\n      sudo vi /etc/shadowsocks-libev/config.json\n     </code>\n    </blockquote>\n    <p>\n     Insert contents as follows, replacing the template parameters with the actual values for your server. Continuing the example given above, this would imply a configuration file like this:\n    </p>\n    <pre>\n{\n  \"server\": \"**.***.***.***\",\n  \"server_port\": 29974,\n  \"local_address\": \"127.0.0.1\",\n  \"local_port\":1080,\n  \"password\": \"Br8FwfLbjRaeqj55\",\n  \"method\": \"chacha20-ietf-poly1305\",\n  \"timeout\": 300,\n  \"fast_open\": false,\n  \"nameserver\": \"8.8.8.8\",\n  \"mode\": \"tcp_only\"\n}\n</pre>\n    <img alt=\"Shadowsocks client configuration JSON file\" src=\"../images/proxy-ss-config.png\"/>\n    <p>\n     The parameters you specify on the client must match up with what you chose on the server.\n    </p>\n    <p>\n     Save the file\n     <code>\n      /etc/shadowsocks-libev/config.json\n     </code>\n     .\n    </p>\n    <h3>\n     <a id=\"1-4\">\n     </a>\n     1.4. Configure Systemd Service File on Gateway\n    </h3>\n    <p>\n     Edit the systemd service file\n     <code>\n      /lib/systemd/system/shadowsocks-libev.service\n     </code>\n     .\n    </p>\n    <blockquote>\n     <code>\n      sudo vi /lib/systemd/system/shadowsocks-libev.service\n     </code>\n    </blockquote>\n    <p>\n     Make the file look like this:\n    </p>\n    <pre>\n[Unit]\nDescription=Shadowsocks-Libev Local Client\nDocumentation=man:ss-local(1)\nAfter=network.target\n[Service]\nType=simple\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE\nAmbientCapabilities=CAP_NET_BIND_SERVICE\nUser=tunnel\nGroup=tunnel\nExecStart=/usr/bin/ss-local -c /etc/shadowsocks-libev/config.json\n[Install]\nWantedBy=multi-user.target\n</pre>\n    <img alt=\"Shadowsocks client systemd service file\" src=\"../images/proxy-systemd-service.png\"/>\n    <p>\n     Save the file\n     <code>\n      /lib/systemd/system/shadowsocks-libev.service\n     </code>\n     .\n    </p>\n    <p>\n     Reload systemd for your changes:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl daemon-reload\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-5\">\n     </a>\n     1.5. Start Shadowsocks-Libev Client on Gateway\n    </h3>\n    <p>\n     Restart Shadowsocks-Libev with your new configuration:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl restart shadowsocks-libev\n     </code>\n    </blockquote>\n    <p>\n     Check that the Shadowsocks-Libev client is running and listening on port\n     <code>\n      1080\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl status shadowsocks-libev\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      ss -tulpn | grep 1080\n     </code>\n    </blockquote>\n    <p>\n     Close the terminal emulator.\n    </p>\n    <h3>\n     <a id=\"1-6\">\n     </a>\n     1.6. Reconfigure Anon Connection Wizard\n    </h3>\n    <p>\n     Tor on Whonix is controlled by the configuration files stored in the Gateway machine’s directory\n     <code>\n      /usr/local/etc/torrc.d\n     </code>\n     . We can write new\n     <code>\n      torrc\n     </code>\n     files automatically by reinvoking the\n     <strong>\n      Anon Connection Wizard\n     </strong>\n     . It is under the\n     <strong>\n      System\n     </strong>\n     menu group.\n    </p>\n    <img alt=\"Anon Connection Wizard with Configure selected\" src=\"../images/proxy-configure.png\"/>\n    <ol>\n     <li>\n      Select\n      <strong>\n       Configure\n      </strong>\n      .\n     </li>\n     <li>\n      Check or do not check the box for bridges, as you prefer.\n     </li>\n     <li>\n      Check the box to say you want to use a proxy before connecting to the Tor network.\n     </li>\n     <li>\n      Specify the\n      <strong>\n       SOCKS5\n      </strong>\n      proxy on\n      <code>\n       127.0.0.1\n      </code>\n      port\n      <code>\n       1080\n      </code>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Next\n      </strong>\n     </li>\n     <li>\n      Click\n      <strong>\n       Next\n      </strong>\n      again\n     </li>\n     <li>\n      Wait for the Tor bootstrapping to reach 100%.\n     </li>\n     <li>\n      Click\n      <strong>\n       Finish\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     When the Anon Connection Wizard runs, it writes the new\n     <code>\n      torrc\n     </code>\n     to\n     <code>\n      /usr/local/etc/torrc.d/40_tor_control_panel.conf\n     </code>\n     . Advanced users can add extra parameters in\n     <code>\n      /usr/local/etc/torrc.d/50_user.conf\n     </code>\n     if they manually restart Tor afterwards.\n    </p>\n    <p>\n     Minimize the Gateway virtual machine.\n    </p>\n    <h3>\n     <a id=\"1-7\">\n     </a>\n     1.7. Check Workstation\n    </h3>\n    <p>\n     Go to the Workstation virtual machine. Open the Whonix Tor Browser. Do an end-to-end test of your connectivity by visiting\n     <a href=\"https://check.torproject.org\" target=\"_blank\">\n      https://check.torproject.org\n     </a>\n     .\n    </p>\n    <img alt=\"Congratulations: This browser is configured to use Tor\" src=\"../images/proxy-congratulations.png\"/>\n    <h2>\n     <a id=\"3\">\n     </a>\n     2. Troubleshooting\n    </h2>\n    <p>\n     If you experience any difficulties operating Whonix, visit the\n     <a href=\"https://forums.whonix.org\" target=\"_blank\">\n      Whonix forums\n     </a>\n     .\n    </p>\n    <p>\n     For Shadowsocks, you can ask questions on social media, or file legitimate issues on the appropriate GitHub issues page:\n    </p>\n    <ul>\n     <li>\n      <a href=\"https://github.com/shadowsocks/shadowsocks-libev/issues\" target=\"_blank\">\n       Shadowsocks-Libev\n      </a>\n     </li>\n    </ul>\n    <p>\n     <em>\n      Updated 2021-06-19\n     </em>\n    </p>\n   </div>\n  </div>\n  <div id=\"footer\">\n   <div class=\"content\">\n    <p>\n     This site is provided for information only. It cannot replace the advice of a trained security professional. If lives or safety depend on your security, please seek the advice of an expert.\n    </p>\n   </div>\n  </div>\n </body>\n</html>\n"
}