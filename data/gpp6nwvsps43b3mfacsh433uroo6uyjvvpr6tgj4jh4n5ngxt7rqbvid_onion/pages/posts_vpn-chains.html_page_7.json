{
    "html_content": "<!DOCTYPE html>\n<html lang=\"en\">\n <head>\n  <meta charset=\"utf-8\"/>\n  <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\"/>\n  <title>\n   VPN Chains\n  </title>\n  <link href=\"../general.css\" rel=\"stylesheet\" type=\"text/css\"/>\n </head>\n <body>\n  <div id=\"header\">\n   <div class=\"content\">\n    <h2>\n     <a href=\"/\">\n      Oil and Fish\n     </a>\n    </h2>\n   </div>\n  </div>\n  <div id=\"main\">\n   <div class=\"content\">\n    <h1>\n     VPN Chains\n    </h1>\n    <p>\n     The earliest mention I can find of VPN chains is a\n     <a href=\"http://secure-computing.net/wiki/index.php/OpenVPN/VpnChains\" target=\"_blank\">\n      2010 article\n     </a>\n     by Eric Crist. That article envisaged a literal chain, in which one client connects to a server, which in turn connects to a further server, and on. It did not give any practical details.\n    </p>\n    <p>\n     The interest in VPN chains since then has been more in tunneling one connection through another. In particular, the question of how to build a tunnel through a tunnel was raised in a\n     <a href=\"https://forums.openvpn.net/viewtopic.php?t=7483\" target=\"_blank\">\n      2011 forum thread\n     </a>\n     started by Bebop. A finished set of bash scripts was posted on\n     <a href=\"https://sourceforge.net/p/vpnchains/wiki/Home\" target=\"_blank\">\n      SourceForge\n     </a>\n     in 2012 by br41n. In 2017, the scripts were added to\n     <a href=\"https://github.com/TensorTom/VPN-Chain\" target=\"_blank\">\n      GitHub\n     </a>\n     by TensorTom. These inspired Mirimir to create an alternative set of\n     <a href=\"https://github.com/mirimir/vpnchains\" target=\"_blank\">\n      bash scripts\n     </a>\n     in 2019.\n    </p>\n    <p>\n     A VPN chain disguises your destination from your ISP and VPN1, and disguises your origin from VPN2 and your final destination website. If your goal is anonymity, you will likely use commercial VPN services who accept anonymous payment. However, for demonstration purposes we will build our own VPN servers from scratch.\n    </p>\n    <p>\n     The two servers and one client in this demonstration all run Debian 10. We will give the IP addresses of the two OpenVPN servers as\n     <code>\n      11.11.11.11\n     </code>\n     and\n     <code>\n      22.22.22.22\n     </code>\n     respectively. We also refer to them as VPN1 and VPN2.\n    </p>\n    <h2>\n     <a id=\"1\">\n     </a>\n     1. Set Up Servers\n    </h2>\n    <h3>\n     <a id=\"1-1\">\n     </a>\n     1.1. Create VPN1 Server\n    </h3>\n    <p>\n     Since this article is not primarily about VPN server configuration, we will go through this quickly. Install a basic firewall on your server:\n    </p>\n    <blockquote>\n     <code>\n      iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -i lo -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -p icmp -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -p tcp --dport 22 -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -P INPUT DROP\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      apt update &amp;&amp; apt upgrade -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      apt install iptables-persistent -y\n     </code>\n    </blockquote>\n    <p>\n     Install OpenVPN using a prewritten script:\n    </p>\n    <blockquote>\n     <code>\n      apt install curl -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      chmod +x openvpn-install.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      ./openvpn-install.sh\n     </code>\n    </blockquote>\n    <p>\n     When the script asks you questions, you can the defaults all the way through, unless you have some reason to change them. When it asks for the name of a client, call it\n     <code>\n      vpn1\n     </code>\n     . This results in the script creating a client configuration file named\n     <code>\n      vpn1.ovpn\n     </code>\n     .\n    </p>\n    <p>\n     For clarity, and so that we do not end up with overlapping virtual address ranges, we will change the IP addresses given out by the OpenVPN server. Edit the server configuration file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/openvpn/server.conf\n     </code>\n    </blockquote>\n    <p>\n     Change the address range to\n     <code>\n      10.8.1.0/24\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      server 10.8.1.0 255.255.255.0\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Also edit the iptables rules created when the server comes up, and make the corresponding change there:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/iptables/add-openvpn-rules.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -t nat -I POSTROUTING 1 -s 10.8.1.0/24 -o eth0 -j MASQUERADE\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Do the same thing when the iptables rules are deleted when the server goes down:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/iptables/rm-openvpn-rules.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -t nat -D POSTROUTING -s 10.8.1.0/24 -o eth0 -j MASQUERADE\n     </code>\n    </blockquote>\n    <p>\n     Save the file. At this point, it’s cleanest to simply reboot:\n    </p>\n    <blockquote>\n     <code>\n      reboot\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-2\">\n     </a>\n     1.2. Create VPN2 Server\n    </h3>\n    <p>\n     This is pretty much the same procedure as the VPN1 server, with some small changes. Create the basic firewall:\n    </p>\n    <blockquote>\n     <code>\n      iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -i lo -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -p icmp -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -A INPUT -p tcp --dport 22 -j ACCEPT\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -P INPUT DROP\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      apt update &amp;&amp; apt upgrade -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      apt install iptables-persistent -y\n     </code>\n    </blockquote>\n    <p>\n     Install OpenVPN using the script:\n    </p>\n    <blockquote>\n     <code>\n      apt install curl -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      chmod +x openvpn-install.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      ./openvpn-install.sh\n     </code>\n    </blockquote>\n    <p>\n     You can leave the server operating on port 1194 by UDP. Name the client\n     <code>\n      vpn2\n     </code>\n     . This creates a file on this server named\n     <code>\n      vpn2.ovpn\n     </code>\n     .\n    </p>\n    <p>\n     To avoid confusion, we will use the range\n     <code>\n      10.8.2.0/24\n     </code>\n     for VPN2. Edit the server configuration file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/openvpn/server.conf\n     </code>\n    </blockquote>\n    <p>\n     Change the address range to\n     <code>\n      10.8.2.0/24\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      server 10.8.2.0 255.255.255.0\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Also edit the iptables rules created when the server comes up:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/iptables/add-openvpn-rules.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -t nat -I POSTROUTING 1 -s 10.8.2.0/24 -o eth0 -j MASQUERADE\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Do the same thing when the iptables rules are deleted:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/iptables/rm-openvpn-rules.sh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      iptables -t nat -D POSTROUTING -s 10.8.2.0/24 -o eth0 -j MASQUERADE\n     </code>\n    </blockquote>\n    <p>\n     Save the file, and reboot:\n    </p>\n    <blockquote>\n     <code>\n      reboot\n     </code>\n    </blockquote>\n    <h2>\n     <a id=\"2\">\n     </a>\n     2. Set Up Client\n    </h2>\n    <h3>\n     <a id=\"2-1\">\n     </a>\n     2.1. Install Packages\n    </h3>\n    <p>\n     Now go to work on your client PC. Install all the packages we’ll need for this demonstration:\n    </p>\n    <blockquote>\n     <code>\n      sudo apt update &amp;&amp; sudo apt upgrade -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo apt install openvpn resolvconf curl tcpdump wireshark -y\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"2-2\">\n     </a>\n     2.2. Get OVPN Files\n    </h3>\n    <p>\n     Retrieve the client configuration files from their respective servers:\n    </p>\n    <blockquote>\n     <code>\n      scp root@11.11.11.11:vpn1.ovpn ~/Downloads/\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      scp root@22.22.22.22:vpn2.ovpn ~/Downloads/\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"2-3\">\n     </a>\n     2.3. Set Up Client for VPN1\n    </h3>\n    <p>\n     Determine the IP address of your PC’s default gateway:\n    </p>\n    <blockquote>\n     <code>\n      ip r | grep default\n     </code>\n    </blockquote>\n    <p>\n     We will use as our example the IP address\n     <code>\n      10.0.2.2\n     </code>\n     .\n    </p>\n    <p>\n     Edit the downloaded configuration file for VPN1:\n    </p>\n    <blockquote>\n     <code>\n      vi ~/Downloads/vpn1.ovpn\n     </code>\n    </blockquote>\n    <p>\n     Insert a couple of lines that prevent the OpenVPN client from accepting routes pushed by the server, and instead manually add a route to the VPN1 server via your default gateway:\n    </p>\n    <blockquote>\n     <code>\n      route-nopull\n      <br/>\n      route 11.11.11.11 255.255.255.255 10.0.2.2\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Copy the amended configuration file into the OpenVPN directory:\n    </p>\n    <blockquote>\n     <code>\n      sudo cp ~/Downloads/vpn1.ovpn /etc/openvpn/vpn1.conf\n     </code>\n    </blockquote>\n    <p>\n     Connect your PC to the VPN1 server:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl start openvpn@vpn1\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"2-4\">\n     </a>\n     2.4. Test Connection to VPN1\n    </h3>\n    <p>\n     Check the connection to the VPN1 server:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl status openvpn@vpn1\n     </code>\n    </blockquote>\n    <p>\n     You should see a message\n     <code>\n      Initialization Sequence Completed\n     </code>\n     .\n    </p>\n    <p>\n     Now, just for testing purposes, manually add routes that will send the client’s entire traffic through the tunnel:\n    </p>\n    <blockquote>\n     <code>\n      sudo ip r add 0.0.0.0/1 via 10.8.1.1 dev tun0\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo ip r add 128.0.0.0/1 via 10.8.1.1 dev tun0\n     </code>\n    </blockquote>\n    <p>\n     Check that you have outbound connectivity:\n    </p>\n    <blockquote>\n     <code>\n      ping 8.8.8.8\n     </code>\n    </blockquote>\n    <p>\n     Do\n     <strong>\n      Ctrl\n     </strong>\n     +\n     <strong>\n      c\n     </strong>\n     to stop ping. Check that DNS resolution works:\n    </p>\n    <blockquote>\n     <code>\n      ping www.yahoo.com\n     </code>\n    </blockquote>\n    <p>\n     Do\n     <strong>\n      Ctrl\n     </strong>\n     +\n     <strong>\n      c\n     </strong>\n     to stop ping. Confirm the address at which your packets emerge from the tunnel:\n    </p>\n    <blockquote>\n     <code>\n      curl ifconfig.me &amp;&amp; echo ''\n     </code>\n    </blockquote>\n    <p>\n     You should see the IP address of VPN1. Assuming all is well, manually delete your added routes:\n    </p>\n    <blockquote>\n     <code>\n      sudo ip r del 0.0.0.0/1\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo ip r del 128.0.0.0/1\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"2-5\">\n     </a>\n     2.5. Set Up Client for VPN2\n    </h3>\n    <p>\n     Get the IP address of your gateway on the first tunnel interface, which is usually named\n     <code>\n      tun0\n     </code>\n     . In our example, the gateway will be\n     <code>\n      10.8.1.1\n     </code>\n     .\n    </p>\n    <p>\n     Edit your client configuration file for VPN2:\n    </p>\n    <blockquote>\n     <code>\n      vi ~/Downloads/vpn2.ovpn\n     </code>\n    </blockquote>\n    <p>\n     Insert a couple of lines that prevent the OpenVPN client from accepting routes pushed by the server, and instead manually add a route to the VPN2 server via your first tunnel:\n    </p>\n    <blockquote>\n     <code>\n      route-nopull\n      <br/>\n      route 22.22.22.22 255.255.255.255 10.8.1.1\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Copy the client configuration file for VPN2 into the OpenVPN directory:\n    </p>\n    <blockquote>\n     <code>\n      sudo cp ~/Downloads/vpn2.ovpn /etc/openvpn/vpn2.conf\n     </code>\n    </blockquote>\n    <p>\n     Start the OpenVPN client for VPN2:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl start openvpn@vpn2\n     </code>\n    </blockquote>\n    <p>\n     Check the connection to the server:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl status openvpn@vpn2\n     </code>\n    </blockquote>\n    <p>\n     You should see a message\n     <code>\n      Initialization Sequence Completed\n     </code>\n     .\n    </p>\n    <p>\n     Manually add routes that will send your PC’s entire traffic through the second tunnel:\n    </p>\n    <blockquote>\n     <code>\n      sudo ip r add 0.0.0.0/1 via 10.8.2.1 dev tun1\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo ip r add 128.0.0.0/1 via 10.8.2.1 dev tun1\n     </code>\n    </blockquote>\n    <h2>\n     <a id=\"3\">\n     </a>\n     3. End-to-End Test\n    </h2>\n    <p>\n     Check that you have outbound connectivity:\n    </p>\n    <blockquote>\n     <code>\n      ping 8.8.8.8\n     </code>\n    </blockquote>\n    <p>\n     Do\n     <strong>\n      Ctrl\n     </strong>\n     +\n     <strong>\n      c\n     </strong>\n     to stop ping. Check that DNS resolution works:\n    </p>\n    <blockquote>\n     <code>\n      ping www.yahoo.com\n     </code>\n    </blockquote>\n    <p>\n     Do\n     <strong>\n      Ctrl\n     </strong>\n     +\n     <strong>\n      c\n     </strong>\n     to stop ping. Confirm the address at which your packets emerge from the tunnels:\n    </p>\n    <blockquote>\n     <code>\n      curl ifconfig.me &amp;&amp; echo ''\n     </code>\n    </blockquote>\n    <p>\n     You should now see the IP address of VPN2.\n    </p>\n    <p>\n     Determine your main interface:\n    </p>\n    <blockquote>\n     <code>\n      ip a\n     </code>\n    </blockquote>\n    <p>\n     Let’s say, for example, that it is\n     <code>\n      enp0s3\n     </code>\n     . Capture the packets that go out from\n     <code>\n      enp0s3\n     </code>\n     to either VPN1 or VPN2:\n    </p>\n    <blockquote>\n     <code>\n      sudo tcpdump -i enp0s3 -w capture.pcap host 11.11.11.11 or host 22.22.22.22\n     </code>\n    </blockquote>\n    <p>\n     Leave tcpdump running in your first terminal window. Open a second terminal window and reissue the command:\n    </p>\n    <blockquote>\n     <code>\n      curl ifconfig.me &amp;&amp; echo ''\n     </code>\n    </blockquote>\n    <p>\n     Of course, you should still see the VPN2 server address, but we did this mainly to capture the packets going out.\n    </p>\n    <p>\n     Close the second terminal window. In the first terminal window, do\n     <strong>\n      Ctrl\n     </strong>\n     +\n     <strong>\n      c\n     </strong>\n     to stop tcpdump.\n    </p>\n    <p>\n     Launch the Wireshark application. In Wireshark, open your file\n     <code>\n      capture.pcap\n     </code>\n     .\n    </p>\n    <p>\n     You should see all your packets go out to VPN1, and none to VPN2.\n    </p>\n    <p>\n     Finally, open Firefox and visit\n     <a href=\"https://ipchicken.com\" target=\"_blank\">\n      IPchicken.com\n     </a>\n     to make sure HTTPS traffic emerges from the tunnels at the VPN2 IP address.\n    </p>\n    <h2>\n     <a id=\"4\">\n     </a>\n     4. Finish Up\n    </h2>\n    <p>\n     When you are done, delete the manually added rules:\n    </p>\n    <blockquote>\n     <code>\n      sudo ip r del 0.0.0.0/1\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo ip r del 128.0.0.0/1\n     </code>\n    </blockquote>\n    <p>\n     Stop the two OpenVPN clients:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl stop openvpn@vpn1\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo systemctl stop openvpn@vpn2\n     </code>\n    </blockquote>\n    <p>\n     Check that everything is back to normal and that traffic is now emerging directly from your ISP:\n    </p>\n    <blockquote>\n     <code>\n      curl ifconfig.me &amp;&amp; echo ''\n     </code>\n    </blockquote>\n    <h2>\n     <a id=\"5\">\n     </a>\n     5. Get Help and Report Issues\n    </h2>\n    <p>\n     This is a niche area, and there are no official support arrangements.\n    </p>\n    <p>\n     If you run into problems, a couple of suggestions made by people who’ve previously tested VPN chains are to\n     <a href=\"https://github.com/TensorTom/VPN-Chain/issues/7\" target=\"_blank\">\n      change the MTU size to 1400\n     </a>\n     or to\n     <a href=\"https://superuser.com/questions/1521812/use-a-proxy-or-another-vpn-before-connecting-to-a-vpn\" target=\"_blank\">\n      use TCP instead of UDP for one of the connections\n     </a>\n     .\n    </p>\n    <p>\n     For the OpenVPN manual, do\n     <code>\n      man openvpn\n     </code>\n     on Linux, or consult the online\n     <a href=\"https://openvpn.net/community-resources/reference-manual-for-openvpn-2-4\" target=\"_blank\">\n      Reference Manual for OpenVPN 2.4\n     </a>\n     . If you need further support, you can ask on the\n     <a href=\"https://forums.openvpn.net\" target=\"_blank\">\n      OpenVPN forums\n     </a>\n     .\n    </p>\n    <p>\n     <em>\n      Updated 2020-10\n     </em>\n    </p>\n   </div>\n  </div>\n  <div id=\"footer\">\n   <div class=\"content\">\n    <p>\n     This site is provided for information only. It cannot replace the advice of a trained security professional. If lives or safety depend on your security, please seek the advice of an expert.\n    </p>\n   </div>\n  </div>\n </body>\n</html>\n"
}