{
    "html_content": "<!DOCTYPE html>\n<html lang=\"en\">\n <head>\n  <meta charset=\"utf-8\"/>\n  <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\"/>\n  <title>\n   Double VPN with pfSense\n  </title>\n  <link href=\"../general.css\" rel=\"stylesheet\" type=\"text/css\"/>\n </head>\n <body>\n  <div id=\"header\">\n   <div class=\"content\">\n    <h2>\n     <a href=\"/\">\n      Oil and Fish\n     </a>\n    </h2>\n   </div>\n  </div>\n  <div id=\"main\">\n   <div class=\"content\">\n    <h1>\n     Double VPN with pfSense\n    </h1>\n    <p>\n     This article is a 2020 simplification of\n     <a href=\"https://www.ivpn.net/privacy-guides/advanced-privacy-and-anonymity-part-6\" target=\"_blank\">\n      part 6 of the Mirimir Advanced Privacy and Anonymity series\n     </a>\n     , which was originally written in 2013.\n    </p>\n    <img alt=\"Double VPN with Linux KVM, pfSense, and live CD\" src=\"../images/double-vpn-pfsense-0.png\"/>\n    <p>\n     In this configuration:\n    </p>\n    <ul>\n     <li>\n      Your host computer connects to VPN1\n     </li>\n     <li>\n      A gateway VM connects to VPN2, which is tunneled through VPN1\n     </li>\n     <li>\n      You do all your work on a workstation VM\n     </li>\n    </ul>\n    <p>\n     The workstation VM has no direct connection to the Internet. All its traffic is forced to go, via an internal network, through the gateway VM.\n    </p>\n    <p>\n     With two different VPNs, no single party sees both your IP address and your destination site. VPN1 sees only your origin IP address. VPN2 sees only your destination site. Assuming your destination sites uses HTTPS, none of the intermediate parties sees your actual content.\n    </p>\n    <p>\n     The host computer in this tutorial runs Debian. Virtualization is provided by Kernel-based Virtual Machine (KVM). The gateway runs pfSense, and the workstation runs a live CD edition of Debian.\n    </p>\n    <h2>\n     <a id=\"1\">\n     </a>\n     1. Initial Set Up\n    </h2>\n    <h3>\n     <a id=\"1-1\">\n     </a>\n     1.1. Select DNS Provider\n    </h3>\n    <p>\n     The Mirimir tutorial placed great emphasis on the privacy of your DNS requests. The 2013 article recommended you choose from the third-party DNS servers listed by\n     <a href=\"https://wikileaks.org/wiki/Alternative_DNS\" target=\"_blank\">\n      WikiLeaks\n     </a>\n     or\n     <a href=\"https://anonymous-proxy-servers.net/wiki/index.php/Censorship-free_DNS_servers\" target=\"_blank\">\n      JonDonym\n     </a>\n     . Another source is\n     <a href=\"https://public-dns.info\" target=\"_blank\">\n      public-dns.info\n     </a>\n     , which maintains a huge list of public DNS servers that is checked continuously, and which allows you to select DNS servers by country. You could alternatively choose any other DNS provider of your choice, e.g. Google, Cloudflare, Quad9, etc.\n    </p>\n    <p>\n     In the examples in this article:\n    </p>\n    <ul>\n     <li>\n      The host computer uses DNS servers\n      <code>\n       1.1.1.1\n      </code>\n      and\n      <code>\n       1.0.0.1\n      </code>\n      for IPv4, and\n      <code>\n       2606:4700:4700::1111\n      </code>\n      and\n      <code>\n       2606:4700:4700::1001\n      </code>\n      for IPv46\n     </li>\n     <li>\n      The gateway VM uses DNS servers\n      <code>\n       9.9.9.9\n      </code>\n      and\n      <code>\n       149.112.112.112\n      </code>\n     </li>\n     <li>\n      The workstation will be pushed\n      <code>\n       208.67.222.222\n      </code>\n      and\n      <code>\n       208.67.220.220\n      </code>\n     </li>\n    </ul>\n    <h3>\n     <a id=\"1-2a\">\n     </a>\n     1.2a. Configure Host DNS Servers\n    </h3>\n    <p>\n     This section gives the general method for changing DNS servers on Debian with GNOME desktop. The section below describes an alternative method if you choose Cloudflare for your DNS servers.\n    </p>\n    <p>\n     Open GNOME settings, and go to the\n     <strong>\n      Network\n     </strong>\n     page if you use a wired connection or the\n     <strong>\n      Wi-Fi\n     </strong>\n     page if you use wireless.\n    </p>\n    <ul>\n     <li>\n      Set the IPv4 DNS servers to your choices. In our example, those are\n      <code>\n       1.1.1.1\n      </code>\n      and\n      <code>\n       1.0.0.1\n      </code>\n      .\n     </li>\n     <li>\n      If your networking has IPv6 enabled, also set the IPv6 DNS servers to your choices. In our example, those are\n      <code>\n       2606:4700:4700::1111\n      </code>\n      and\n      <code>\n       2606:4700:4700::1001\n      </code>\n      .\n     </li>\n    </ul>\n    <p>\n     In theory you should just have to restart NetworkManager here, but in practice you may need to reboot.\n    </p>\n    <h3>\n     <a id=\"1-2b\">\n     </a>\n     1.2b. Alternative Method for Cloudflare DNS Servers\n    </h3>\n    <p>\n     You can improve your DNS security by installing dnscrypt-proxy. This prevents DNS sniffing and ISP proxying.\n    </p>\n    <blockquote>\n     <code>\n      sudo apt install dnscrypt-proxy\n     </code>\n    </blockquote>\n    <p>\n     Allow dnscrypt-proxy to bind to a privileged port by editing the systemd service file:\n    </p>\n    <blockquote>\n     <code>\n      vi /usr/lib/systemd/system/dnscrypt-proxy.service\n     </code>\n    </blockquote>\n    <p>\n     Remove the line:\n    </p>\n    <blockquote>\n     <code>\n      User=_dnscrypt-proxy\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Reload systemd:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl daemon-reload\n     </code>\n    </blockquote>\n    <p>\n     Edit the configuration:\n    </p>\n    <blockquote>\n     <code>\n      sudo vi /etc/dnscrypt-proxy/dnscrypt-proxy.toml\n     </code>\n    </blockquote>\n    <p>\n     Make it listen on IPv4 (and IPv6 if you use IPv6):\n    </p>\n    <blockquote>\n     <code>\n      listen_addresses = ['127.0.0.1:53', '[::1]:53']\n      <br/>\n      server_names = ['cloudflare', 'cloudflare-ipv6']\n     </code>\n    </blockquote>\n    <p>\n     Start the service:\n    </p>\n    <blockquote>\n     <code>\n      sudo systemctl enable dnscrypt-proxy.service\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo systemctl start dnscrypt-proxy.service\n     </code>\n    </blockquote>\n    <p>\n     As in the section above, change your GNOME settings for your main interface’s nameservers, but this time specify them as\n     <code>\n      127.0.0.1\n     </code>\n     for IPv4 (and\n     <code>\n      ::1\n     </code>\n     for IPv6).\n    </p>\n    <p>\n     In theory you should just have to restart NetworkManager after changing your nameservers, but in practice you may need to:\n    </p>\n    <blockquote>\n     <code>\n      reboot\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-3\">\n     </a>\n     1.3. Create VPN Accounts\n    </h3>\n    <p>\n     You need two VPN providers. Some privacy-focused providers you might consider are\n     <a href=\"https://www.ivpn.net\" target=\"_blank\">\n      IVPN\n     </a>\n     ,\n     <a href=\"https://mullvad.net\" target=\"_blank\">\n      Mullvad\n     </a>\n     , and\n     <a href=\"https://airvpn.org/\" target=\"_blank\">\n      AirVPN\n     </a>\n     . SecurityKISS, mentioned in the original article, discontinued its VPN service in May 2020.\n    </p>\n    <p>\n     As you search for suitable VPN providers, beware of affililate pages posing as reviews. Also be skeptical of claims not to keep logs. In the past, at least one provider turned out to be dishonest in this respect. And watch out for\n     <a href=\"https://www.zdnet.com/article/many-free-mobile-vpn-apps-are-based-in-china-or-have-chinese-ownership\" target=\"_blank\">\n      free VPNs based in mainland China\n     </a>\n     which are under the control of the Chinese Communist Party.\n    </p>\n    <p>\n     When you have your account opened for VPN1, download the configuration file to your host PC. We’ll call it\n     <code>\n      vpn1.ovpn\n     </code>\n     . We’ll import it to the host in a few minutes.\n    </p>\n    <p>\n     The components of the VPN2 configuration need to be split out for pfSense rather than combined in single file. We will do that when we come to the sections for pfSense, so there is nothing to do for now.\n    </p>\n    <h3>\n     <a id=\"1-4\">\n     </a>\n     1.4. Configure VPN1\n    </h3>\n    <p>\n     At this stage, you have all the information you need to configure the VPN1 client on your host PC.\n    </p>\n    <p>\n     The procedure for installing the VPN client will vary, depending on which client software and which VPN provider you chose. Some providers recommend you use the generic OpenVPN client, while others have their own client.\n    </p>\n    <ul>\n     <li>\n      If you are using the generic OpenVPN client, then install it now (\n      <code>\n       sudo apt install network-manager-openvpn-gnome\n      </code>\n      ). Once it’s installed, open GNOME settings, go to the\n      <strong>\n       Network\n      </strong>\n      page, add a new VPN, select\n      <strong>\n       Import from file\n      </strong>\n      , and import\n      <code>\n       vpn1.ovpn\n      </code>\n      .\n     </li>\n     <li>\n      If your provider has their own client, then follow your provider’s instructions to configure VPN1 on your host PC.\n     </li>\n    </ul>\n    <p>\n     You can test connecting to VPN1 now if you want to. Toggle the VPN connection to the ON position. After testing the connection from your browser, disconnect VPN1 (unless you want to leave it running for all the remaining steps).\n    </p>\n    <h2>\n     <a id=\"2\">\n     </a>\n     2. Download ISO Files\n    </h2>\n    <h3>\n     <a id=\"2-1\">\n     </a>\n     2.1. Download pfSense\n    </h3>\n    <p>\n     Download the latest pfSense compressed ISO from the\n     <a href=\"https://www.pfSense.org/download\" target=\"_blank\">\n      pfSense download page\n     </a>\n     .\n    </p>\n    <ol>\n     <li>\n      The\n      <strong>\n       Version\n      </strong>\n      will be prefilled with the latest version (currently\n      <code>\n       2.4.5-p1\n      </code>\n      )\n     </li>\n     <li>\n      For\n      <strong>\n       Architecture\n      </strong>\n      , select AMD64 (64-bit)\n     </li>\n     <li>\n      The\n      <strong>\n       Installer\n      </strong>\n      you want is a CD image (ISO) installer\n     </li>\n     <li>\n      Choose a\n      <strong>\n       Mirror\n      </strong>\n      from New York, Austin TX, Frankfurt, or Singapore\n     </li>\n    </ol>\n    <p>\n     Click the DOWNLOAD button. By default, the file is saved in your\n     <code>\n      Downloads\n     </code>\n     directory. It has a name that looks like\n     <code>\n      pfSense-CE-2.4.5-RELEASE-p1-amd64.iso.gz\n     </code>\n     . We will use this name in our examples, although it may have changed by the time you read this tutorial.\n    </p>\n    <h3>\n     <a id=\"2-2\">\n     </a>\n     2.2. Verify pfSense\n    </h3>\n    <p>\n     The expected SHA256 checksum is displayed underneath the DOWNLOAD button on the\n     <a href=\"https://www.pfSense.org/download\" target=\"_blank\">\n      pfSense download page\n     </a>\n     .\n    </p>\n    <p>\n     Display the actual SHA256 checksum of your downloaded file by issuing the commands:\n    </p>\n    <blockquote>\n     <code>\n      cd ~/Downloads\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sha256sum pfSense-CE-2.4.5-RELEASE-p1-amd64.iso.gz\n     </code>\n    </blockquote>\n    <p>\n     The expected and actual values should be identical.\n    </p>\n    <h3>\n     <a id=\"2-3\">\n     </a>\n     2.3. Extract pfSense ISO\n    </h3>\n    <p>\n     Extract the ISO from the compressed archive:\n    </p>\n    <blockquote>\n     <code>\n      gunzip pfSense-CE-2.4.5-RELEASE-p1-amd64.iso.gz\n     </code>\n    </blockquote>\n    <p>\n     This replaces the compressed file with the extracted ISO file. In our example, it would be named\n     <code>\n      pfSense-CE-2.4.5-RELEASE-p1-amd64.iso\n     </code>\n     .\n    </p>\n    <h3>\n     <a id=\"2-4\">\n     </a>\n     2.4. Download Debian Live CD\n    </h3>\n    <p>\n     Open Firefox and visit the\n     <a href=\"https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid\" target=\"_blank\">\n      Debian Live CD page\n     </a>\n     .\n    </p>\n    <p>\n     Download your chosen version of the 64-bit Debian Live CD. We will choose the XFCE version of Debian, since it is lighter on resource usage than GNOME.\n    </p>\n    <p>\n     At the time of writing, the ISO file is named\n     <code>\n      debian-live-10.5.0-amd64-xfce.iso\n     </code>\n     . We will use this name in our sample commands. It may have changed by the time you read this tutorial. The current live CD ISO file is a 2.2 GB download.\n    </p>\n    <h3>\n     <a id=\"2-5\">\n     </a>\n     2.5. Get Debian Signing Key\n    </h3>\n    <p>\n     The fingerprint of the Debian CD signing key is given on the\n     <a href=\"https://www.debian.org/CD/verify\" target=\"_blank\">\n      Debian website\n     </a>\n     as\n     <code>\n      DF9B 9C49 EAA9 2984 3258 9D76 DA87 E80D 6294 BE9B\n     </code>\n     . Download the public key from the Debian keyserver:\n    </p>\n    <blockquote>\n     <code>\n      gpg --keyserver keyring.debian.org --recv-keys DF9B9C49EAA9298432589D76DA87E80D6294BE9B\n     </code>\n    </blockquote>\n    <p>\n     The Debian CD signing key is imported.\n    </p>\n    <h3>\n     <a id=\"2-6\">\n     </a>\n     2.6. Verify Debian Live CD\n    </h3>\n    <p>\n     From the\n     <a href=\"https://cdimage.debian.org/debian-cd/current-live/amd64/iso-hybrid\" target=\"_blank\">\n      Debian Live CD page\n     </a>\n     , download the checksum file\n     <code>\n      SHA512SUMS\n     </code>\n     and its signature\n     <code>\n      SHA512SUMS.sign\n     </code>\n     . You will probably have to right-click and select\n     <strong>\n      Save Link As\n     </strong>\n     to download these two files.\n    </p>\n    <p>\n     Verify the SHA512 checksums file:\n    </p>\n    <blockquote>\n     <code>\n      cd ~/Downloads\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      gpg --verify SHA512SUMS.sign SHA512SUMS\n     </code>\n    </blockquote>\n    <p>\n     The results should include a message,\n     <code>\n      Good signature\n     </code>\n     . Do not worry if there is an additional message,\n     <code>\n      There is no indication that the signature belongs to the owner\n     </code>\n     .\n    </p>\n    <p>\n     Display the expected SHA512 checksum by issuing the command:\n    </p>\n    <blockquote>\n     <code>\n      cat SHA512SUMS | grep debian-live-10.5.0-amd64-xfce.iso\n     </code>\n    </blockquote>\n    <p>\n     Display the actual SHA512 checksum of the Debian Live CD ISO file:\n    </p>\n    <blockquote>\n     <code>\n      sha512sum debian-live-10.5.0-amd64-xfce.iso\n     </code>\n    </blockquote>\n    <p>\n     The expected and actual values should be identical.\n    </p>\n    <h2>\n     <a id=\"3\">\n     </a>\n     3. Set Up Virtualization\n    </h2>\n    <h3>\n     <a id=\"3-1\">\n     </a>\n     3.1. Prepare Firewall\n    </h3>\n    <p>\n     Livbirt uses iptables to support virtualization. There have been reports of conflicts arising if you use nftables as your firewall. Until this issue is resolved, it’s best to use iptables for your machine’s basic firewall. Therefore if you are using nftables, stop and disable it, uninstall it, then reconstruct your basic firewall with iptables.\n    </p>\n    <h3>\n     <a id=\"3-2\">\n     </a>\n     3.2. Install KVM\n    </h3>\n    <p>\n     Install the Virtual Machine Manager and all its dependencies, which include\n     <code>\n      qemu-kvm\n     </code>\n     and\n     <code>\n      libvirt\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      sudo apt update &amp;&amp; sudo apt upgrade -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo apt install virt-manager\n     </code>\n    </blockquote>\n    <p>\n     Add yourself to the group that manages virtual machines:\n    </p>\n    <blockquote>\n     <code>\n      sudo usermod -aG libvirt\n      <em>\n       myuserid\n      </em>\n     </code>\n    </blockquote>\n    <p>\n     Replace\n     <code>\n      <em>\n       myuserid\n      </em>\n     </code>\n     in the above by your actual user id on the host.\n    </p>\n    <p>\n     In theory, you could just log off and log on again at this point. In practice, it is often better to reboot after installing virtualization:\n    </p>\n    <blockquote>\n     <code>\n      sudo reboot\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"3-3\">\n     </a>\n     3.3. Start Default Network\n    </h3>\n    <p>\n     From\n     <strong>\n      Activities\n     </strong>\n     , search for\n     <code>\n      virt\n     </code>\n     . Start Virtual Machine Manager.\n    </p>\n    <p>\n     Right-click on\n     <code>\n      QEMU/KVM\n     </code>\n     . Select\n     <strong>\n      Details\n     </strong>\n     . Select the\n     <strong>\n      Virtual Networks\n     </strong>\n     tab.\n    </p>\n    <p>\n     The network named\n     <code>\n      default\n     </code>\n     should be active and set to autostart on boot. If not, open a terminal and issue the commands:\n    </p>\n    <blockquote>\n     <code>\n      sudo virsh net-autostart default\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      sudo virsh net-start default\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"3-4\">\n     </a>\n     3.4. Create Internal Network\n    </h3>\n    <p>\n     Still on the\n     <strong>\n      Virtual Networks\n     </strong>\n     tab, click the plus sign (\n     <strong>\n      +\n     </strong>\n     ) and add a new internal network. In the wizard:\n    </p>\n    <ol>\n     <li>\n      For the network name, put\n      <code>\n       intnet\n      </code>\n      , and click\n      <strong>\n       Forward\n      </strong>\n     </li>\n     <li>\n      Uncheck all the IPv4 options, and click\n      <strong>\n       Forward\n      </strong>\n     </li>\n     <li>\n      Uncheck all the IPv6 options, and click\n      <strong>\n       Forward\n      </strong>\n     </li>\n     <li>\n      Select\n      <strong>\n       Isolated virtual network\n      </strong>\n      , blank out the DNS domain name at the bottom, and click\n      <strong>\n       Finish\n      </strong>\n     </li>\n    </ol>\n    <p>\n     The new network\n     <code>\n      intnet\n     </code>\n     should be active and set to autostart on boot.\n    </p>\n    <p>\n     Close the\n     <code>\n      QEMU/KVM\n     </code>\n     connection details window.\n    </p>\n    <img alt=\"Creating a new network in Virtual Machine Manager\" src=\"../images/double-vpn-pfsense-1.png\"/>\n    <h2>\n     <a id=\"4\">\n     </a>\n     4. Set Up Gateway\n    </h2>\n    <h3>\n     <a id=\"4-1\">\n     </a>\n     4.1. Create Gateway VM\n    </h3>\n    <p>\n     Create a new virtual machine in Virtual Machine Manager (\n     <strong>\n      File\n     </strong>\n     &gt;\n     <strong>\n      New Virtual Machine\n     </strong>\n     ).\n    </p>\n    <ol>\n     <li>\n      Select\n      <strong>\n       Local install media\n      </strong>\n      , and click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Browse to\n      <code>\n       pfSense-CE-2.4.5-RELEASE-p1-amd64.iso\n      </code>\n      . Uncheck automatic operating system detection. Type\n      <code>\n       FreeBSD\n      </code>\n      (since pfSense is based on FreeBSD), and select the latest version. Click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Put memory\n      <code>\n       1024\n      </code>\n      , CPUs\n      <code>\n       1\n      </code>\n      , and click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Put disk image\n      <code>\n       4.0\n      </code>\n      GiB, and click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Name the machine\n      <code>\n       Gateway\n      </code>\n      .\n     </li>\n    </ol>\n    <p>\n     Do not click\n     <strong>\n      Finish\n     </strong>\n     just yet! We are going to add a second network interface card.\n    </p>\n    <ol>\n     <li>\n      Check the box\n      <strong>\n       Customize configuration before install\n      </strong>\n      .\n     </li>\n     <li>\n      Now that you’ve checked that box, you can click\n      <strong>\n       Finish\n      </strong>\n      .\n     </li>\n     <li>\n      Select the existing NIC.\n     </li>\n     <li>\n      Set the device model to\n      <code>\n       e1000\n      </code>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Apply\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Add Hardware\n      </strong>\n      .\n     </li>\n     <li>\n      Select the\n      <strong>\n       Network\n      </strong>\n      page.\n     </li>\n     <li>\n      Select network source\n      <code>\n       Virtual network intnet\n      </code>\n      .\n     </li>\n     <li>\n      Now you can click\n      <strong>\n       Finish\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     Your virtual machine is ready to go with two virtual network interface cards, one for the\n     <code>\n      default\n     </code>\n     NAT network, and one for the isolated internal\n     <code>\n      intnet\n     </code>\n     network.\n    </p>\n    <img alt=\"VM with two network interface cards in Virtual Machine Manager\" src=\"../images/double-vpn-pfsense-2.png\"/>\n    <h3>\n     <a id=\"4-2\">\n     </a>\n     4.2. Install pfSense on Gateway VM\n    </h3>\n    <p>\n     Now you can click\n     <strong>\n      Begin Installation\n     </strong>\n     to start the gateway VM. If necessary, allow the Virtual Machine Manager to inhibit your normal keyboard shortcuts on the host.\n    </p>\n    <p>\n     In the console window, select option\n     <code>\n      1\n     </code>\n     for\n     <code>\n      Boot Multi User\n     </code>\n     , or just leave it a few seconds until it does this by default.\n    </p>\n    <ol>\n     <li>\n      On the Copyright and distribution notice, select\n      <strong>\n       Accept\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n     <li>\n      On the Welcome screen, select\n      <strong>\n       I\n      </strong>\n      for install pfSense, then\n      <strong>\n       OK\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n     <li>\n      On the Keymap Selection screen, select your keyboard, then\n      <strong>\n       Select\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n     <li>\n      For Partitioning, select\n      <strong>\n       A\n      </strong>\n      for Auto (UFS) Guided Disk Setup, then\n      <strong>\n       OK\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n     <li>\n      Wait while the Archive Extraction proceeds\n     </li>\n     <li>\n      For additional Manual Configuration, select\n      <strong>\n       No\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n     <li>\n      On the Complete screen, select\n      <strong>\n       Reboot\n      </strong>\n      and press\n      <strong>\n       Enter\n      </strong>\n     </li>\n    </ol>\n    <h3>\n     <a id=\"4-3\">\n     </a>\n     4.3. Change Internal Network IP Addresses\n    </h3>\n    <p>\n     The gateway machine reboots. You will notice that when pfSense starts, it allocates\n     <code>\n      192.168.1.1/24\n     </code>\n     for the internal network (the LAN, from pfSense’s point of view). This will work, but it could create confusion, since consumer routers often use this range for home networks.\n    </p>\n    <img alt=\"pfSense first start up\" src=\"../images/double-vpn-pfsense-3.png\"/>\n    <p>\n     We’ll change the internal network to use the subnet\n     <code>\n      192.168.100.1/24\n     </code>\n     .\n    </p>\n    <p>\n     Enter option\n     <code>\n      2\n     </code>\n     to set the interface IP address.\n    </p>\n    <ol>\n     <li>\n      When asked which of the available interfaces you want to configure, enter\n      <code>\n       2\n      </code>\n      for the LAN\n     </li>\n     <li>\n      For the new IP address, put\n      <code>\n       192.168.100.1\n      </code>\n     </li>\n     <li>\n      For the subnet bit count, put\n      <code>\n       24\n      </code>\n     </li>\n     <li>\n      There is no upstream gateway for the LAN, so leave it blank\n     </li>\n     <li>\n      There is no LAN IPv6 address, so leave it blank\n     </li>\n     <li>\n      For DHCP server, put\n      <code>\n       y\n      </code>\n      for yes\n     </li>\n     <li>\n      For start address for the client range, put\n      <code>\n       192.168.100.64\n      </code>\n     </li>\n     <li>\n      For start address for the client range, put\n      <code>\n       192.168.100.127\n      </code>\n     </li>\n     <li>\n      When asked if you want the webConfigurator to revert to HTTP, put\n      <code>\n       n\n      </code>\n      for no\n     </li>\n     <li>\n      When the new webConfigurator address is displayed, check that it looks right, then press\n      <strong>\n       Enter\n      </strong>\n     </li>\n    </ol>\n    <p>\n     The pfSense main menu is redisplayed with your new LAN IP address of\n     <code>\n      192.168.100.1\n     </code>\n     .\n    </p>\n    <p>\n     Leave the pfSense virtual machine running. You can minimize its window if you like.\n    </p>\n    <h2>\n     <a id=\"5\">\n     </a>\n     5. Set Up Workstation\n    </h2>\n    <p>\n     Create a second virtual machine in Virtual Machine Manager (\n     <strong>\n      File\n     </strong>\n     &gt;\n     <strong>\n      New Virtual Machine\n     </strong>\n     ).\n    </p>\n    <ol>\n     <li>\n      Select\n      <strong>\n       Local install media\n      </strong>\n      , and click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Browse to\n      <code>\n       debian-live-10.5.0-amd64-xfce.iso\n      </code>\n      . Uncheck automatic operating system detection. Type\n      <code>\n       Debian 10\n      </code>\n      and select Debian 10. Click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Since this will be your workstation, you can give it as much resources as you like. For example, you might put memory\n      <code>\n       2048\n      </code>\n      and CPUs\n      <code>\n       2\n      </code>\n      . Click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Do not give it a disk! The idea is that this should be a live CD workstation. After the host computer is turned off, no traces will remain of its activity. Therefore uncheck\n      <strong>\n       Enable storage for this virtual machine\n      </strong>\n      . Click\n      <strong>\n       Forward\n      </strong>\n      .\n     </li>\n     <li>\n      Name the machine\n      <code>\n       Workstation\n      </code>\n      .\n     </li>\n     <li>\n      Most importantly, expand Network selection, and select\n      <code>\n       Virtual network intnet\n      </code>\n      . This machine must not be attached to the NAT network!\n     </li>\n    </ol>\n    <p>\n     Click\n     <strong>\n      Finish\n     </strong>\n     . Select\n     <strong>\n      Debian GNU/Linux Live\n     </strong>\n     .\n    </p>\n    <p>\n     When the XFCE desktop appears, go to\n     <strong>\n      Applications\n     </strong>\n     &gt;\n     <strong>\n      Settings\n     </strong>\n     &gt;\n     <strong>\n      Display\n     </strong>\n     and make the resolution bigger if you like. You may need to resize the window for the workstation.\n    </p>\n    <h2>\n     <a id=\"6\">\n     </a>\n     6. Run pfSense Set Up Wizard\n    </h2>\n    <h3>\n     <a id=\"6-1\">\n     </a>\n     6.1. First Time Login\n    </h3>\n    <p>\n     We’re going to log into the pfSense WebGUI from the workstation VM.\n    </p>\n    <p>\n     In the workstation VM, open Firefox (\n     <strong>\n      Applications\n     </strong>\n     &gt;\n     <strong>\n      Web Browser\n     </strong>\n     ).\n    </p>\n    <ol>\n     <li>\n      Navigate to\n      <code>\n       https://192.168.100.1\n      </code>\n      . This was the LAN address we chose for the pfSense gateway VM.\n     </li>\n     <li>\n      You will see a warning about a potential security risk. This is because the certificate is self-signed.\n     </li>\n     <li>\n      Click\n      <strong>\n       Advanced\n      </strong>\n      .\n     </li>\n     <li>\n      Scroll down. Click\n      <strong>\n       Accept the Risk and Continue\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     Sign in as user\n     <code>\n      admin\n     </code>\n     with password\n     <code>\n      pfsense\n     </code>\n     . We’ll change the default password in a moment.\n    </p>\n    <h3>\n     <a id=\"6-2\">\n     </a>\n     6.2. Run Set Up Wizard\n    </h3>\n    <p>\n     The first-time wizard is displayed immediately.\n    </p>\n    <ol>\n     <li>\n      On the Welcome screen, click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the Global Support screen, click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the General Information screen, put your choices of DNS servers for the gateway. In our example, we are going to use primary\n      <code>\n       9.9.9.9\n      </code>\n      and secondary\n      <code>\n       149.112.112.112\n      </code>\n      here. Uncheck the box that allows these to be overridden from the WAN. Click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the Time Server screen, click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the WAN screen, click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the LAN screen, you will see your choice of\n      <code>\n       192.168.100.1\n      </code>\n      . Click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the Password screen, choose your new administrator password, reenter it, and click\n      <strong>\n       Next\n      </strong>\n      .\n     </li>\n     <li>\n      On the Reload screen, click\n      <strong>\n       Reload\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     Wait for the reload to complete.\n    </p>\n    <p>\n     Now, back in the gateway console, choose option\n     <code>\n      5\n     </code>\n     and confirm with\n     <code>\n      y\n     </code>\n     for yes to reboot pfSense.\n    </p>\n    <h2>\n     <a id=\"7\">\n     </a>\n     7. Add VPN Client to pfSense\n    </h2>\n    <h3>\n     <a id=\"7-1\">\n     </a>\n     7.1. Get VPN Details\n    </h3>\n    <p>\n     At this point, the workstation has direct access to the Internet via the gateway.\n    </p>\n    <p>\n     If you want extra privacy, you could turn on VPN1 on the host for a moment. Download the configuration file from your VPN2 provider to your workstation VM. You can then turn off VPN1 on the host.\n    </p>\n    <p>\n     For pfSense, you are going to have to extract details from your VPN2 configuration file. You can use the text editor (\n     <strong>\n      Applications\n     </strong>\n     &gt;\n     <strong>\n      Accessories\n     </strong>\n     &gt;\n     <strong>\n      Mousepad\n     </strong>\n     ) for this. You want to be able to identify:\n    </p>\n    <ul>\n     <li>\n      The Certificate Authority (CA) certificate\n     </li>\n     <li>\n      The client certificate\n     </li>\n     <li>\n      The client key\n     </li>\n     <li>\n      All the other configuration parameters\n     </li>\n    </ul>\n    <p>\n     Not all VPN providers will give you all the certificates. Procedures vary tremendously from VPN provider to VPN provider. Some give you separate files; some give you an all-in-one configuration file.\n    </p>\n    <h3>\n     <a id=\"7-2\">\n     </a>\n     7.2. Add Certificates\n    </h3>\n    <p>\n     In most cases, whether all-in-one or separate files, you will get a CA certificate, a client certificate, and a client key. In the pfSense WebGUI running on your workstation, log in using your new password rather than the default. Go to\n     <strong>\n      System\n     </strong>\n     &gt;\n     <strong>\n      Cert. Manager\n     </strong>\n     .\n    </p>\n    <p>\n     On the\n     <strong>\n      CAs\n     </strong>\n     tab, add a new CA certificate.\n    </p>\n    <ol>\n     <li>\n      The name can be\n      <code>\n       ca2\n      </code>\n      or whatever you like.\n     </li>\n     <li>\n      Method is\n      <strong>\n       Import an existing Certificate Authority\n      </strong>\n      .\n     </li>\n     <li>\n      Copy and paste the contents of your provider’s CA certificate to the box for\n      <strong>\n       Certificate data\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     On the\n     <strong>\n      Certificates\n     </strong>\n     tab, add a new certificate.\n    </p>\n    <ol>\n     <li>\n      Method is\n      <strong>\n       Import an existing Certificate\n      </strong>\n      .\n     </li>\n     <li>\n      Name can be\n      <code>\n       client2\n      </code>\n      or whatever you like.\n     </li>\n     <li>\n      Copy and paste the contents of client certificate to the box for\n      <strong>\n       Certificate data\n      </strong>\n      .\n     </li>\n     <li>\n      Copy and paste the contents of your client key to the box for\n      <strong>\n       Private key data\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n    </ol>\n    <img alt=\"Creating new certificate in pfSense\" src=\"../images/double-vpn-pfsense-4.png\"/>\n    <h3>\n     <a id=\"7-3\">\n     </a>\n     7.3. Add OpenVPN Client\n    </h3>\n    <p>\n     In the pfSense WebGUI running on your workstation, go to\n     <strong>\n      VPN\n     </strong>\n     &gt;\n     <strong>\n      OpenVPN\n     </strong>\n     . Go to the\n     <strong>\n      Clients\n     </strong>\n     tab. Click the button to a new VPN client.\n    </p>\n    <p>\n     The details are highly dependent on what your VPN2 provider gave you in the\n     <code>\n      vpn2.ovpn\n     </code>\n     file. Again, this will vary from VPN provider to VPN provider. What follows is very much just an example.\n    </p>\n    <ul>\n     <li>\n      You may be able to leave many fields at their default values.\n     </li>\n     <li>\n      <strong>\n       Server host or address\n      </strong>\n      is the IP address of the VPN2 server.\n     </li>\n     <li>\n      You will get a username and password from most VPN providers.\n     </li>\n     <li>\n      <strong>\n       Use a TLS key\n      </strong>\n      was checked (in our example).\n     </li>\n     <li>\n      <strong>\n       Automatically generate a TLS key\n      </strong>\n      was unchecked because we are going to enter it from the configuration file.\n     </li>\n     <li>\n      <strong>\n       TLS key\n      </strong>\n      for us was the OpenVPN static key between the open and closing\n      <code>\n       tls-crypt\n      </code>\n      tags in the\n      <code>\n       .ovpn\n      </code>\n      file.\n     </li>\n     <li>\n      <strong>\n       TLS Key Usage Mode\n      </strong>\n      was\n      <strong>\n       TLS Encryption and Authentication\n      </strong>\n      .\n     </li>\n     <li>\n      <strong>\n       Client certificate\n      </strong>\n      was\n      <code>\n       client2\n      </code>\n      .\n     </li>\n     <li>\n      <strong>\n       Encryption algorithm\n      </strong>\n      in our example was\n      <strong>\n       AES-128-GCM\n      </strong>\n      .\n     </li>\n     <li>\n      <strong>\n       Compression\n      </strong>\n      in our example was\n      <strong>\n       Omit preference (use OpenVPN default)\n      </strong>\n      .\n     </li>\n     <li>\n      <strong>\n       Custom options\n      </strong>\n      (separated by semicolons) were\n      <code>\n       persist-key; persist-tun; remote-cert-tls server; tls-cipher TLS-ECDHE-ECDSA-WITH-AES-128-GCM-SHA256\n      </code>\n     </li>\n    </ul>\n    <p>\n     Just to emphasize the point, you will have to change all the above according to the configuration of your VPN2 provider’s server. The values given were just examples.\n    </p>\n    <p>\n     When you have entered all the details for your VPN2, click\n     <strong>\n      Save\n     </strong>\n     .\n    </p>\n    <img alt=\"Creating OpenVPN client in pfSense\" src=\"../images/double-vpn-pfsense-5.png\"/>\n    <h3>\n     <a id=\"7-4\">\n     </a>\n     7.4. Check VPN Status\n    </h3>\n    <p>\n     In the pfSense WebGUI running on your workstation, go to\n     <strong>\n      Status\n     </strong>\n     &gt;\n     <strong>\n      OpenVPN\n     </strong>\n     . The\n     <strong>\n      Status\n     </strong>\n     should be\n     <code>\n      up\n     </code>\n     .\n    </p>\n    <p>\n     Go to\n     <strong>\n      Status\n     </strong>\n     &gt;\n     <strong>\n      System Logs\n     </strong>\n     &gt;\n     <strong>\n      OpenVPN\n     </strong>\n     . The messages should include\n     <code>\n      Initialization Sequence Completed\n     </code>\n     .\n    </p>\n    <h3>\n     <a id=\"7-5\">\n     </a>\n     7.5. Amend DHCP Server DNS Servers\n    </h3>\n    <p>\n     These are the DNS servers that will be pushed to the workstation. Look again at\n     <strong>\n      Status\n     </strong>\n     &gt;\n     <strong>\n      System Logs\n     </strong>\n     &gt;\n     <strong>\n      OpenVPN\n     </strong>\n     . See if there is a line\n     <code>\n      PUSH: Received control message\n     </code>\n     . If so, look for\n     <code>\n      dhcp-option DNS\n     </code>\n     followed by IP addresses.\n    </p>\n    <ul>\n     <li>\n      If you received pushed DNS servers, go to\n      <strong>\n       Services\n      </strong>\n      &gt;\n      <strong>\n       DHCP Server\n      </strong>\n      and specify those IP addresses as your DNS servers.\n     </li>\n     <li>\n      If you did\n      <em>\n       not\n      </em>\n      receive pushed DNS servers, go to\n      <strong>\n       Services\n      </strong>\n      &gt;\n      <strong>\n       DHCP Server\n      </strong>\n      and specify some other DNS servers from the sources listed in\n      <a href=\"#1-1\">\n       section 1.1\n      </a>\n      above. The idea is to segment your DNS usage over different servers whenever possible. We are using\n      <code>\n       208.67.222.222\n      </code>\n      and\n      <code>\n       208.67.220.220\n      </code>\n      in this example.\n     </li>\n    </ul>\n    <p>\n     Click\n     <strong>\n      Save\n     </strong>\n     .\n    </p>\n    <img alt=\"Amending DHCP DNS servers in pfSense\" src=\"../images/double-vpn-pfsense-6.png\"/>\n    <h3>\n     <a id=\"7-6\">\n     </a>\n     7.6. Create Interface\n    </h3>\n    <p>\n     At this point, pfSense is not routing anything through OpenVPN, and your workstation VM has no Internet connectivity. That’s normal. Don’t worry.\n    </p>\n    <p>\n     Go to\n     <strong>\n      Interfaces\n     </strong>\n     &gt;\n     <strong>\n      Assignments\n     </strong>\n     . Click the plus sign\n     <strong>\n      +\n     </strong>\n     to create\n     <code>\n      OPT1\n     </code>\n     interface\n     <code>\n      ovpnc1\n     </code>\n     (OpenVPN client interface 1).\n    </p>\n    <ol>\n     <li>\n      Click\n      <code>\n       OPT1\n      </code>\n      to edit its details.\n     </li>\n     <li>\n      Check\n      <strong>\n       Enable interface\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Apply Changes\n      </strong>\n      .\n     </li>\n    </ol>\n    <img alt=\"Add OPT1 interface in pfSense\" src=\"../images/double-vpn-pfsense-7.png\"/>\n    <h3>\n     <a id=\"7-7\">\n     </a>\n     7.7. Configure NAT\n    </h3>\n    <p>\n     Now we configure Network Address Translation (NAT) for the new interface\n     <code>\n      OPT1\n     </code>\n     . Go to\n     <strong>\n      Firewall\n     </strong>\n     &gt;\n     <strong>\n      NAT\n     </strong>\n     .\n    </p>\n    <ol>\n     <li>\n      Select the\n      <strong>\n       Outbound\n      </strong>\n      tab.\n     </li>\n     <li>\n      Select\n      <strong>\n       Manual Outbound NAT rule generation\n      </strong>\n      ..\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Apply Changes\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     After the changes are applied, there will be either four or six rules: two for localhost to WAN IPv4, possibly two for localhost to WAN IPv6, and two for LAN to WAN.\n    </p>\n    <p>\n     Add a new rule for interface\n     <code>\n      OPT1\n     </code>\n     , with source equal to your subnet\n     <code>\n      192.168.100.1/24\n     </code>\n     . Click\n     <strong>\n      Save\n     </strong>\n     .\n    </p>\n    <p>\n     Hit the\n     <strong>\n      Apply Changes\n     </strong>\n     button.\n    </p>\n    <img alt=\"Configure NAT outbound in pfSense\" src=\"../images/double-vpn-pfsense-8.png\"/>\n    <h3>\n     <a id=\"7-8\">\n     </a>\n     7.8. Edit LAN Rules\n    </h3>\n    <p>\n     We will change the rules to allow output from the LAN on our\n     <code>\n      OPT1\n     </code>\n     interface but to block any IPv6 traffic. Navigate to\n     <strong>\n      Firewall\n     </strong>\n     &gt;\n     <strong>\n      Rules\n     </strong>\n     . Go to the\n     <strong>\n      LAN\n     </strong>\n     tab.\n    </p>\n    <p>\n     Edit the existing rule\n     <code>\n      Default allow LAN to any rule\n     </code>\n     .\n    </p>\n    <ol>\n     <li>\n      Change the\n      <strong>\n       Description\n      </strong>\n      to\n      <code>\n       Allow LAN to any rule via OPT1\n      </code>\n      .\n     </li>\n     <li>\n      Display\n      <strong>\n       Advanced Options\n      </strong>\n      .\n     </li>\n     <li>\n      Scroll down\n      <strong>\n       Gateway\n      </strong>\n      and select\n      <code>\n       OPT1_VPNV4\n      </code>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     Also edit the existing rule\n     <code>\n      Default allow LAN IPv6 to any rule\n     </code>\n     .\n    </p>\n    <ol>\n     <li>\n      Change the\n      <strong>\n       Action\n      </strong>\n      from\n      <strong>\n       Pass\n      </strong>\n      to\n      <strong>\n       Block\n      </strong>\n      .\n     </li>\n     <li>\n      Click\n      <strong>\n       Save\n      </strong>\n      .\n     </li>\n    </ol>\n    <p>\n     Click\n     <strong>\n      Apply Changes\n     </strong>\n     .\n    </p>\n    <img alt=\"Firewall LAN rules in pfSense\" src=\"../images/double-vpn-pfsense-9.png\"/>\n    <h3>\n     <a id=\"7-9\">\n     </a>\n     7.9. Complete Set Up\n    </h3>\n    <ol>\n     <li>\n      Shut down the workstation from the XFCE desktop.\n     </li>\n     <li>\n      Back in the pfSense VM console window, halt system by entering\n      <code>\n       6\n      </code>\n      and then\n      <code>\n       y\n      </code>\n      to confirm.\n     </li>\n    </ol>\n    <h2>\n     <a id=\"8\">\n     </a>\n     8. End-to-End Test\n    </h2>\n    <ol>\n     <li>\n      On the host PC, connect VPN1. Allow a few seconds for VPN1 to connect. From Firefox on the host, visit\n      <a href=\"https://ipchicken.com/\" target=\"_blank\">\n       IPchicken.com\n      </a>\n      . You should see the VPN1 server IP address.\n     </li>\n     <li>\n      Power on the gateway VM. After the pfSense bootup, there should be three interfaces (\n      <code>\n       WAN\n      </code>\n      ,\n      <code>\n       LAN\n      </code>\n      , and\n      <code>\n       OPT1\n      </code>\n      ), and you should have an IP address for the\n      <code>\n       OPT1\n      </code>\n      interface.\n     </li>\n     <li>\n      Start the workstation from the live CD.\n     </li>\n     <li>\n      In Firefox on the workstation, test your connection all the way to a website. In particular, visit\n      <a href=\"https://ipchicken.com/\" target=\"_blank\">\n       IPchicken.com\n      </a>\n      or a similar site. You should see the VPN2 server IP address. You are therefore reaching VPN2 through your VPN1 tunnel.\n     </li>\n    </ol>\n    <h2>\n     <a id=\"9\">\n     </a>\n     9. Get Help and Report Issues\n    </h2>\n    <p>\n     Here are some avenues for support:\n    </p>\n    <ul>\n     <li>\n      <a href=\"https://forum.netgate.com/category/66/pfSense-software\" target=\"_blank\">\n       Netgate pfSense forum\n      </a>\n     </li>\n     <li>\n      <a href=\"https://www.debian.org/support\" target=\"_blank\">\n       Debian support\n      </a>\n     </li>\n     <li>\n      <a href=\"https://forums.openvpn.net\" target=\"_blank\">\n       OpenVPN forums\n      </a>\n     </li>\n    </ul>\n    <p>\n     <em>\n      Updated 2020-09\n     </em>\n    </p>\n   </div>\n  </div>\n  <div id=\"footer\">\n   <div class=\"content\">\n    <p>\n     This site is provided for information only. It cannot replace the advice of a trained security professional. If lives or safety depend on your security, please seek the advice of an expert.\n    </p>\n   </div>\n  </div>\n </body>\n</html>\n"
}