{
    "html_content": "<!DOCTYPE html>\n<html lang=\"en\">\n <head>\n  <meta charset=\"utf-8\"/>\n  <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\"/>\n  <title>\n   L2TP/IPsec with PSK with Libreswan\n  </title>\n  <link href=\"../general.css\" rel=\"stylesheet\" type=\"text/css\"/>\n </head>\n <body>\n  <div id=\"header\">\n   <div class=\"content\">\n    <h2>\n     <a href=\"/\">\n      Oil and Fish\n     </a>\n    </h2>\n   </div>\n  </div>\n  <div id=\"main\">\n   <div class=\"content\">\n    <h1>\n     L2TP/IPsec with PSK with Libreswan\n    </h1>\n    <p>\n     In this scenario, Layer 2 Tunneling Protocol (L2TP) is combined with IPsec. This arrangement uses fixed port numbers and is therefore easily blocked by censors. Also, a preshared key (PSK) is not particularly secure. Nevertheless, there may be situations where ease-of-use is your top priority. Many client devices support L2TP/IPsec PSK without the installation of additional software.\n    </p>\n    <p>\n     This configuration requires xL2TPd as well as Libreswan. For a simpler configuration, review the article on\n     <a href=\"ipsec-libreswan.html\">\n      IPsec with Libreswan\n     </a>\n     .\n    </p>\n    <p>\n     The article on this page will show you how to create an L2TP/IPsec server on CentOS 8. Note that CentOS 8 reaches end-of-life on December 31, 2021.\n    </p>\n    <p>\n     In the examples, your workstation is at IP address\n     <code>\n      xx.xx.xx.xx\n     </code>\n     , and the server is at IP address\n     <code>\n      yy.yy.yy.yy\n     </code>\n     . Wherever you see these values in the examples, you will need to change them to match your actual IP addresses. If you do not know your workstationâ€™s IP address, you can determine it by opening a browser and visiting\n     <a href=\"https://www.ipchicken.com\" target=\"_blank\">\n      IPchicken.com\n     </a>\n     .\n    </p>\n    <p>\n     We also give instructions for an Android device as a sample client. Mobile devices are easily tracked and strongly linked to an individual. Again, we assume ease-of-use is your main concern in this scenario and that you are in a country where L2TP/IPsec is not blocked.\n    </p>\n    <h2>\n     <a id=\"1\">\n     </a>\n     1. Server\n    </h2>\n    <h3>\n     <a id=\"1-1\">\n     </a>\n     1.1. Install and Configure Firewall\n    </h3>\n    <p>\n     We begin by installing a firewall and configuring it to accept IPsec. We also masquerade outgoing IP addresses. Issue the commands that follow:\n    </p>\n    <blockquote>\n     <code>\n      yum update -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      yum install firewalld -y\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      systemctl enable firewalld\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      systemctl start firewalld\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --add-service=ipsec\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --add-masquerade\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --runtime-to-permanent\n     </code>\n    </blockquote>\n    <p>\n     For better security, restrict port 22 access to trusted IP addresses only. For example, if you always log in from IP address\n     <code>\n      xx.xx.xx.xx\n     </code>\n     , make that the only IP address that will be trusted for SSH access:\n    </p>\n    <blockquote>\n     <code>\n      firewall-cmd --zone=trusted --add-service=ssh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --zone=trusted --add-source=xx.xx.xx.xx/32\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --zone=public --remove-service=ssh\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --zone=public --remove-service=cockpit\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      firewall-cmd --runtime-to-permanent\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-2\">\n     </a>\n     1.2. Allow Forwarding\n    </h3>\n    <p>\n     Now enable packet forwarding in the Linux kernel. Create a new configuration file in\n     <code>\n      /usr/lib/sysctl.d\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      vi /usr/lib/sysctl.d/40-ipv4-forward.conf\n     </code>\n    </blockquote>\n    <p>\n     Insert a single line:\n    </p>\n    <blockquote>\n     <code>\n      net.ipv4.ip_forward=1\n     </code>\n    </blockquote>\n    <p>\n     Save the file. Make this change effective immediately.:\n    </p>\n    <blockquote>\n     <code>\n      sysctl -p /usr/lib/sysctl.d/40-ipv4-forward.conf\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-3\">\n     </a>\n     1.3. Install Packages\n    </h3>\n    <p>\n     Add the Extra Packages for Enterprise Linux repository:\n    </p>\n    <blockquote>\n     <code>\n      yum install epel-release -y\n     </code>\n    </blockquote>\n    <p>\n     Install LibreSwan and xL2TPd:\n    </p>\n    <blockquote>\n     <code>\n      yum install libreswan xl2tpd -y\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-4\">\n     </a>\n     1.4. Set Up Preshared Key\n    </h3>\n    <p>\n     Edit the IPsec secrets file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/ipsec.d/psk.secrets\n     </code>\n    </blockquote>\n    <p>\n     Insert a line with your preshared key. We will use as an example a preshared key of\n     <code>\n      ArialBrainChimpDentsEarth\n     </code>\n     :\n    </p>\n    <blockquote>\n     <code>\n      %any: PSK \"ArialBrainChimpDentsEarth\"\n     </code>\n    </blockquote>\n    <p>\n     Save the file.\n    </p>\n    <h3>\n     <a id=\"1-5\">\n     </a>\n     1.5. Configure Libreswan\n    </h3>\n    <p>\n     Create a new file for L2TP/IPsec connections with a preshared key:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/ipsec.d/l2tp-ipsec-psk.conf\n     </code>\n    </blockquote>\n    <p>\n     Insert lines specifying a configuration like this:\n    </p>\n    <pre>\nconn ikev1\n    authby=secret\n    pfs=no\n    auto=add\n    rekey=no\n    left=%defaultroute\n    right=%any\n    ikev2=never\n    ike=aes256-sha2,aes128-sha2,aes256-sha1,aes128-sha1,aes256-sha2;modp1024\n    esp=aes256-sha2_512,aes128-sha2_512,aes256-sha1,aes128-sha1;modp1024\n    type=transport\n    leftprotoport=17/1701\n    rightprotoport=17/%any\n    dpddelay=15\n    dpdtimeout=30\n    dpdaction=clear\n        \nconn ikev1-nat\n    also=ikev1\n    rightsubnet=vhost:%priv\n</pre>\n    <p>\n     Save the file.\n    </p>\n    <h3>\n     <a id=\"1-6\">\n     </a>\n     1.6. Configure xL2TPd\n    </h3>\n    <p>\n     Edit the xL2TPd configuration file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/xl2tpd/xl2tpd.conf\n     </code>\n    </blockquote>\n    <p>\n     Insert a configuration like this. Change the virtual IP address range and local IP of the server if you wish.\n    </p>\n    <pre>\n[global]\nipsec saref = yes\n\n[lns default]\nip range = 10.0.8.64-10.0.8.127\nlocal ip = 10.0.8.1\nrequire chap = yes\nrefuse pap = yes\nrequire authentication = yes\npppoptfile = /etc/ppp/options.xl2tpd\nlength bit = yes\n</pre>\n    <p>\n     Save the file. If you want more explanation of what the options do, issue the command:\n    </p>\n    <blockquote>\n     <code>\n      man xl2tpd.conf\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-7\">\n     </a>\n     1.7. Configure Point-to-Point Protocol Options\n    </h3>\n    <p>\n     Edit the Point-to-Point Protocol options file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/ppp/options.xl2tpd\n     </code>\n    </blockquote>\n    <p>\n     Insert a configuration like this:\n    </p>\n    <pre>\nipcp-accept-local\nipcp-accept-remote\nms-dns 8.8.8.8\nms-dns 1.1.1.1\nnoccp\nauth\nidle 1800\nmtu 1410\nmru 1410\nnodefaultroute\ndebug\nproxyarp\nconnect-delay 5000\n</pre>\n    <p>\n     Save the file. If you want more explanation of what the options do, issue the command:\n    </p>\n    <blockquote>\n     <code>\n      man pppd\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-8\">\n     </a>\n     1.8. Set Up Usernames and Passwords\n    </h3>\n    <p>\n     Edit the Point-to-Point Protocol secrets file:\n    </p>\n    <blockquote>\n     <code>\n      vi /etc/ppp/chap-secrets\n     </code>\n    </blockquote>\n    <p>\n     Insert usernames and passwords like this:\n    </p>\n    <pre>\n# Secrets for authentication using CHAP\n# client server secret      IP addresses\nalice    *      \"ku9mvc94\"  *\nbob      *      \"szkkzg2s\"  *\ncarol    *      \"dft97m29\"  *\n</pre>\n    <p>\n     Save the file.\n    </p>\n    <h3>\n     <a id=\"1-9\">\n     </a>\n     1.9. Start Libreswan\n    </h3>\n    <p>\n     Start Libreswan after every reboot, and also start it now:\n    </p>\n    <blockquote>\n     <code>\n      systemctl enable ipsec\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      systemctl start ipsec\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-10\">\n     </a>\n     1.10. Start xL2TPd\n    </h3>\n    <p>\n     Start xL2TPd after every reboot, and also start it now:\n    </p>\n    <blockquote>\n     <code>\n      systemctl enable xl2tpd\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      systemctl start xl2tpd\n     </code>\n    </blockquote>\n    <h3>\n     <a id=\"1-11\">\n     </a>\n     1.11. Check Libreswan and xL2TPd\n    </h3>\n    <p>\n     Check that Libreswan and xL2TPd are active and running:\n    </p>\n    <blockquote>\n     <code>\n      systemctl status ipsec\n     </code>\n    </blockquote>\n    <blockquote>\n     <code>\n      systemctl status xl2tpd\n     </code>\n    </blockquote>\n    <h2>\n     <a id=\"2\">\n     </a>\n     2. Android Client\n    </h2>\n    <p>\n     The place where you add a VPN in Android varies from release to release. It may be under\n     <strong>\n      Settings\n     </strong>\n     &gt;\n     <strong>\n      Network &amp; Internet\n     </strong>\n     &gt;\n     <strong>\n      Advanced\n     </strong>\n     &gt;\n     <strong>\n      VPN\n     </strong>\n     or it may be under\n     <strong>\n      Settings\n     </strong>\n     &gt;\n     <strong>\n      Connections\n     </strong>\n     &gt;\n     <strong>\n      More networks\n     </strong>\n     &gt;\n     <strong>\n      VPN\n     </strong>\n     .\n    </p>\n    <p>\n     Add a new VPN:\n    </p>\n    <ul>\n     <li>\n      Name is whatever you want, e.g.\n      <code>\n       yy.yy.yy.yy\n      </code>\n     </li>\n     <li>\n      Type is\n      <strong>\n       L2TP/IPsec PSK\n      </strong>\n     </li>\n     <li>\n      Server address in our example is\n      <code>\n       yy.yy.yy.yy\n      </code>\n     </li>\n     <li>\n      L2TP secret is blank\n     </li>\n     <li>\n      IPsec identifier is blank\n     </li>\n     <li>\n      IPsec pre-shared key is\n      <code>\n       ArialBrainChimpDentsEarth\n      </code>\n      in our example\n     </li>\n     <li>\n      Username\n      <code>\n       alice\n      </code>\n     </li>\n     <li>\n      Password\n      <code>\n       ku9mvc94\n      </code>\n     </li>\n    </ul>\n    <p>\n     Click\n     <strong>\n      Save\n     </strong>\n     . Select the VPN, and click\n     <strong>\n      Connect\n     </strong>\n     .\n    </p>\n    <h2>\n     <a id=\"3\">\n     </a>\n     3. Note for Windows Clients\n    </h2>\n    <p>\n     If you try this with a Windows client, it will be necessary to change the adapter settings for the L2TP/IPsec adapter. Right-click on the L2TP/IPsec adapter, and select\n     <strong>\n      Properties\n     </strong>\n     . On the\n     <strong>\n      Security\n     </strong>\n     tab, select the radio button for\n     <strong>\n      Allow these protocols\n     </strong>\n     . Check the boxes for\n     <strong>\n      Unencrypted password (PAP)\n     </strong>\n     ,\n     <strong>\n      Challenge Handshake Authentication Protocol (CHAP)\n     </strong>\n     , and\n     <strong>\n      Microsoft CHAP Version 2 (MS-CHAP v2)\n     </strong>\n     .\n    </p>\n    <p>\n     Also, it would be better to edit the Windows registry to allow use of\n     <code>\n      modp2048\n     </code>\n     . This would allow the use of stronger Diffie-Hellman groups than the\n     <code>\n      modp1024\n     </code>\n     (DH group 2) in our example configuration. To edit the registry, press the\n     <strong>\n      Win\n     </strong>\n     +\n     <strong>\n      r\n     </strong>\n     keys, type\n     <code>\n      regedit\n     </code>\n     , then press\n     <strong>\n      Enter\n     </strong>\n     . Navigate to\n     <code>\n      HKEY_LOCAL_MACHINE\n     </code>\n     &gt;\n     <code>\n      SYSTEM\n     </code>\n     &gt;\n     <code>\n      CurrentControlSet\n     </code>\n     &gt;\n     <code>\n      Services\n     </code>\n     &gt;\n     <code>\n      Rasman\n     </code>\n     &gt;\n     <code>\n      Parameters\n     </code>\n     . Insert a new DWORD (32-bit value). The name is\n     <code>\n      NegotiateDH2048_AES256\n     </code>\n     . The value is\n     <code>\n      1\n     </code>\n     , which means enable AES-256-CBC and MODP-2048.\n    </p>\n    <h2>\n     <a id=\"4\">\n     </a>\n     4. Get Help and Report Issues\n    </h2>\n    <p>\n     For your client device in general, seek support through the normal channels for that device. For Libreswan in particular, support arrangements are listed in the\n     <a href=\"https://libreswan.org/wiki/Support\" target=\"_blank\">\n      Libreswan wiki\n     </a>\n     .\n    </p>\n    <p>\n     <em>\n      Updated 2021-06-17\n     </em>\n    </p>\n   </div>\n  </div>\n  <div id=\"footer\">\n   <div class=\"content\">\n    <p>\n     This site is provided for information only. It cannot replace the advice of a trained security professional. If lives or safety depend on your security, please seek the advice of an expert.\n    </p>\n   </div>\n  </div>\n </body>\n</html>\n"
}